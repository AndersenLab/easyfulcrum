---
title: "my-vignette"
author: "Matteo Di Bernardo"
date: "10/26/2020"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{my-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Install and load the package:

```{r setup}
# install.packages("devtools")
# devtools::install_github("AndersenLab/easyfulcrum")
library(easyfulcrum)
setwd("~/Desktop")
```

In your base directory (startdir), name the project (projectdirname) and run the `makeDirStructure` function to make a standardized directory of folders for the `easyfulcrum` run. Every collection project should be contained in its own repository. The repository name should follow the `YearMonthPlace` format used for Fulcrum collection projects, e.g. `2020FebruaryAustralia`.<br>

See the [Nematode Collection Protocol](https://docs.google.com/document/d/1aPgPDYobpxzr0BQYgvUsjPWnAGXZmCSQKQ4sDGBXuYM/edit) protocol for more details.

```{r eval = FALSE}
makeDirStructure(startdir = "~/Desktop/",
                 projectdirname = "2020FebruaryAustralia")
# note for Tim + Erik: after running this you should add the photos to the appropriate subfolder
```

The directory structure (as shown below) within the repository is critically important for
`easyfulcrum` functions.
    - The `data` directory contains the  `raw` and `processed` subdirectories.<br>
      - `raw/fulcrum` holds the `.csv` files exported from Fulcrum and `raw/fulcrum/photos` contains `.jpg` files exported from Fulcrum.<br>
      - `raw/sanger` holds the `.ab1`, `.phd.1`, `.scf`, and `.seq` files exported from the sequencing facility.<br>

For a normal `easyfulcrum` run, one would add appropriate `.csv` and `.jpg` files into the appropriate locations after running this function.
      
```
2020FebruaryAustralia/
├── data
│   ├── raw
│       ├── fulcrum
│           ├── nematode_field_sampling.csv
│           ├── nematode_field_sampling_sample_photo.csv
│           ├── nematode_isolation.csv
│           ├── nematode_isolation_s_labeled_plates.csv
│           ├── nematode_isolation_photos.csv
│           ├── photos
│               ├── 0a7a5879-8453-4f20-ab3b-8eabb725d492.jpg
│               ├── 0b16d8c7-3cb3-44a8-8b61-e0789e4062c2.jpg
│               └── ... all collection photos here
│       ├── sanger
│           ├── email@northwestern.edu_01_SEQ1677048A_122319D
│               ├── S-10206_oECA306_A01.ab1
│               ├── S-10206_oECA306_A01.phd.1
│               ├── S-10206_oECA306_A01.scf
│               ├── S-10206_oECA306_A01.seq
│               └── ... more sequences here if present
│           └── ... more sequence folders here if present
│   ├── processed
│       ├── fulcrum
│           ├── empty
│       ├── genotypes
│           ├── empty
│       ├── sanger
│           ├── empty
├── plots
│   ├── empty
├── reports
│   ├── empty
├── scripts
```

We create a character value that is the base directory and project name put together, this will be necessary in a few places in the `easyfulcrum` run. Once the data is loaded as explained above, we would normally run the `readFulcrum` function, but in this case, the `raw_data1` object is on the github repo and is automatically loaded.

```{r}
dir1 <- "~/Desktop/2020FebruaryAustralia"
# raw_fulc1 <- readFulcrum(dir = dir1)
names(easyfulcrum::raw_fulc1)
```

The individual data frames are now processed using the `procFulcrum` function, and flags are added.

```{r}
proc_fulc1 <- procFulcrum(data = raw_fulc1)
```

Three temperature variables are checked using the `checkTemperatures` function. Setting the `return_flags` option to `TRUE` will return a list of three data frames that detail the rows where the flags appear, if the user desires. 

```{r}
#checkParameters(data = proc_fulc1)
flag1.1 <- checkTemperatures(data = proc_fulc1, return_flags = TRUE)
```

In the first two checks, for substrate and ambient temperature, rows are flagged when `raw_substrate_temperature` and `raw_ambient_temperature` are above 40 degrees respectively. The `procFulcrum` function assumes that these temperatures are improperly inputted as Fahrenheit rather than Celsius, and automatically converts values above 40 degrees to the latter.<br>

In the final check for ambient run temperature, rows are flagged when both `raw_ambient_temperature` and `raw_ambient_humidity` get stuck on the same value for 5 or more measurements in a row.<br>

Upon examining the results of `checkTemperatures`, the user may realize that a) some of the substrate and ambient temperatures were indeed above 40 degrees Celsius, and need to be reverted to those values, and/or b) that indeed the humidity and temperature readings were stuck and some of these readings should be discarded.<br>

The `fixTemperatures` function takes a) `fulcrum_id`s that need to be reverted for both substrate temperatures (`substrate_temperature_ids`) and ambient temperatures (`ambient_temperature_ids`) as well as b) `fulcrum_id`s for which humidity and temperature readings need to be set to NA due to improper reading (`ambient_temperature_run_ids`)


```{r}
proc_fulc1_clean <- fixTemperatures(data = proc_fulc1,
                                  substrate_temperature_ids = "fe28600b-c78a-4545-a525-28dfb3e5d84c",
                                  ambient_temperature_ids = "e088d373-6f4a-48c3-b672-2f6a43747595",
                                  ambient_temperature_run_ids =c("fb975ace-0036-4a80-b073-8ff638f35786",
                                                                 "c9313751-3f96-41f6-9d5e-b8dc994f5edb"))
```

The flag variables will be maintained, so rerunning `checkTemperatures` is a good idea to make sure that corrections have been implemented as desired.

```{r}
checkTemperatures(data = proc_fulc1_clean)
```

The individual data frames from the processed Fulcrum object are joined using the `joinFulcrum` function.

```{r}
join_fulc1 <- joinFulcrum(data = proc_fulc1)
```

The `checkJoin` function will conduct 10 different checks for flags in the joined Fulcrum data frame, assessing for duplicates of variables, missing elements, extreme values, and more. Setting the `return_flags` option to `TRUE` will return a list of three data frames that detail the rows where the flags appear, if the user desires. If desired, based on these flags the user can manually edit values, or correct mistakes in the underlying data and quickly re-run the pipeline again.

```{r}
#checkJoin(data = join_data1)
flag1.2 <- checkJoin(data = join_fulc1, return_flags = TRUE)
```

The `annnotateFulcrum` function will add spatial information to the joined Fulcrum data frame, describing if sample collections were collected on specific islands, trails, and/or locations. Examples are included in the package, but a user can specify manually made .csv files and place them in _data/raw/annotate_. If that option is preferred, specifying the base directory as `dir` in `annotateFulcrum` will override the example files. 

```{r}
head(easyfulcrum::island)
head(easyfulcrum::location)
head(easyfulcrum::trails)
```
The `island` and `location` dataframes are composed of simple latitude and longitude starts and ends to create a binding box, while `trails` is composed of a character list of geojson polygon points from geojson output of that can be created on a [bounding box online tool](https://boundingbox.klokantech.com/).

```{r}
anno_fulc1 <- annotateFulcrum(data = join_fulc1)
```

We would normally run the `readGenotypes` function to read in genotyping data from an appropriate Google Sheet, but in this case, the `raw_geno1` object is on the github repo and is automatically loaded. The `col_types` variable will specify of what type the data should be during read in.<br>

Details on how to create genotyping google sheets can be found in the [Nematode Collection Protocol](https://docs.google.com/document/d/1aPgPDYobpxzr0BQYgvUsjPWnAGXZmCSQKQ4sDGBXuYM/edit), look for "wild_isolate_genotyping_template".<br>

For more details on reading in genotyping sheets, look into the [googlesheets4](https://googlesheets4.tidyverse.org/articles/articles/read-sheets.html) package (which underlies this function), as well as further information on how to [specify](https://googlesheets4.tidyverse.org/reference/range_read.html#column-specification) the `col_types` if needed.<br>

```{r}
# raw_geno1 <- readGenotypes(gsKey = c("1CxKJHM6mEu4VvnN2T1ioXiJNZmmmpeosmECP2zeAPmY"))
head(easyfulcrum::raw_geno1)
```

The `checkGenotypes` function has the dual functionality of processing the genotyping data (adds flags) and returning info on those flags if desired. Setting the `return_geno` option to `FALSE` and the `return_flags` option to `FALSE` will return the processed genotyping data and print information on the flags. Both of these cannot be true at the same time.

```{r}
proc_geno1 <- checkGenotypes(geno_data = raw_geno1, fulc_data = anno_fulc1, 
                                  return_geno = TRUE, return_flags = FALSE)
```

However, setting the `return_geno` option to `FALSE` and the `return_flags` option to `TRUE` will return a list of data frames that detail the rows where the flags appear. If desired, based on these flags the user can manually edit values, or correct mistakes in the underlying data and quickly re-run the pipeline again.

```{r}
flag1.3 <- checkGenotypes(geno_data = raw_geno1, fulc_data = anno_fulc1, 
                          return_geno = FALSE, return_flags = TRUE)
```

The `joinGenoFulc` function will join the joined Fulcrum data frame with the genotyping information. This function will also save the processed genotyping information in _data/processed/genotypes_. 

```{r}
join_fulcgeno1 <- joinGenoFulc(geno = proc_geno1, fulc = anno_fulc1, dir = dir1)
```

The `joinGenoFulc` function will process the raw sample photos and add information regarding them to the final data frame of data. 

```{r}
final_data1 <- procPhotos(dir = dir1, data = join_fulcgeno1, max_dim = 500, overwrite = T)
```

The final `makeSpSheet` function will generate a species csv file for the target species in mind.

```{r}
test <- makeSpSheet(data = join_fulcgeno1, target_sp = "Caenorhabditis tropicalis")
```
