---
title: "easyFulcrum"
author: "Author: Matteo Di Bernardo"
date: "`r format(Sys.time(), '%d %b %Y')`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{easyFulcrum}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = F}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The **easyfulcrum** package is a tool to process and analyze ecological field sampling data generated using the Fulcrum mobile application.<br>

The **easyfulcrum** R package offers an organized workflow for processing ecological sampling data generated using the Fulcrum mobile application. **easyfulcrum** provides simple and efficient functions to clean, process, and visualize ecological field sampling and isolation data collected using custom Fulcrum applications. It also provides functions to join these data with genotype information if organisms isolated from the field are identified using molecular barcodes. Together, the Fulcrum mobile application and **easyfulcrum** R package allow researchers to easily implement mobile data-collection, cloud-based databases, and standardized data analysis tools to improve ecological sampling accuracy and efficiency.<br>

### What is Fulcrum?
Fulcrum is a customizable, geographic data-collection platform compatible with Apple iOS and Google Android devices that allows users to collect rich, location-based data. To facilitate large-scale ecological surveys of nematodes that are difficult to identify in the field, we developed two Fulcrum applications. The Nematode field sampling application allows the user to organize various ecological data types associated with the substrate sampled in the field, such as environmental parameters and substrate characteristics. The “Nematode isolation” application helps organize data associated with the specimens isolated from samples after they have been brought into the laboratory.<br>

### Fulcrum installation and application customization
The Fulcrum data collection application can be downloaded online (https://www.fulcrumapp.com). Fulcrum uses a powerful GUI to help users customize data-collection applications even when they have no coding or database administration knowledge, which makes Fulcrum’s robust, cloud-based database adaptable to sampling nearly any species from nature. If desired, users can customize our field collection and isolation applications following our Fulcrum templates.<br>

* The template for the Nematode field sampling application is here: [https://www.fulcrumapp.com/apps/nematode-field-sampling]<br>
* The Nematode isolation template is here: [https://www.fulcrumapp.com/apps/nematode-isolation]<br>

Users can use the applications as is, but in order for **easyfulcrum** to work with custom applications, users should save their field sampling application and isolation applications with a unique identifier in the place of our nematode prefix, e.g. fungus field sampling and fungus isolation.<br>

### easyfulcrum installation:

Install the package via devtools (>= 2.4.1):

```{r eval = F}
install.packages("devtools")
devtools::install_github("AndersenLab/easyfulcrum")
```

Load the package:

```{r}
library(easyfulcrum)
```

### Directory structure:

The `makeDirStructure` function makes a standardized directory of folders for the **easyfulcrum** run, taking a base directory (`startdir`) and the project name (`projectdirname`) as inputs.<br> 

Every collection project should be contained in its own directory. The directory name should follow the `YearMonthPlace` format used for Fulcrum collection projects, e.g. `2020JanuaryHawaii`.<br>

```{r warning = F, message = F}
makeDirStructure(startdir = "~/Desktop",
                 projectdirname = "2020JanuaryHawaii")
```

The `data` directory contains the  `raw` and `processed` subdirectories.<br>
    - `raw/fulcrum` holds the `.csv` files exported from Fulcrum and `raw/fulcrum/photos` contains `.jpg` files exported from Fulcrum.<br>
    - `raw/annotate` can hold spatial location files `island.csv`, `location.csv`, and `trail.csv` that the user generates for mapping the collection sites.<br>
    - `processed/fulcrum` holds **easyfulcrum** function outputs.<br>
    
The `reports` directory holds **easyfulcrum** function outputs. These outputs will be generated by the user processing script(s) saved in the `scripts` directory.<br>

Following `makeDirStructure`, the user adds collection `.csv` and `.jpg` files into the appropriate subfolder locations.

We include example files from a small collection to use with this vignette. To copy these files into the project directory you just made we
include a helper function called `loadExampleFiles`. This function is not used in the normal **easyfulcrum** workflow. Note, the (`startdir`) and (`projectdirname`) should be identical to arguments above for the `makeDirStructure` function.

```{r warning = F, message = F}
loadExampleFiles(startdir = "~/Desktop",
                 projectdirname = "2020JanuaryHawaii")
```

### Reading, processing, and joining Fulcrum results:

The first group of functions cleans the results from the Fulcrum `.csv` files.<br>

#### readFulcrum:

`readFulcrum` takes a `dir` argument that specifies the directory to read in Fulcrum `.csv` files. This will be useful throughout the package.

```{r message = F}
dir <- "~/Desktop/2020JanuaryHawaii"
raw_fulc <- readFulcrum(dir = dir)
```

#### procFulcrum:

`procFulcrum` processes individual data frames and adds flags for unexpected data.

```{r}
proc_fulc <- procFulcrum(data = raw_fulc)
```

#### checkTemperatures:

`checkTemperatures` identifies flags in three temperature variables. Setting the `return_flags` option to `TRUE` will return a list of three data frames that pulls only the rows where each of the three flag types appear. The function automatically prints the rows where the flags exist.<br>

`procFulcrum` function assumes that, when `raw_substrate_temperature` or `raw_ambient_temperature` temperatures are above 40 degrees, the temperatures were mistakenly input as Fahrenheit rather than Celsius, and converts these values to Celsius. It will also notice when both `raw_ambient_temperature` and `raw_ambient_humidity` get stuck on the same value for 5 or more measurements in a row. These are the three flags returned above.<br>

```{r}
flag1.1 <- checkTemperatures(data = proc_fulc, return_flags = TRUE)
```

#### fixTemperatures: 

`fixTemperatures` takes a) `fulcrum_id`s that need to be reverted *back to their original values* (if readings above 40 degrees were truly in Celsius) for both substrate temperatures (`substrate_temperature_ids`) and ambient temperatures (`ambient_temperature_ids`) as well as b) `fulcrum_id`s for which humidity and temperature readings need to be set to NA due to a stuck measurement device (`ambient_temperature_run_ids`).

```{r}
proc_fulc_clean <- fixTemperatures(data = proc_fulc,
                                   substrate_temperature_ids = "a7db618d-44cc-4b4a-bc67-871306029274",
                                   ambient_temperature_ids = "b1f20ae4-c5c2-426f-894a-e1f46c2fa693",
                                   ambient_temperature_run_ids=c("dda77efe-d73c-48e9-aefb-b508e613256b",
                                                                 "93de14a0-40ab-4793-8614-ab1512ab158c"))
```

The flag variables will be maintained, so rerunning `checkTemperatures` on the cleaned processed fulcrum data will ensure that corrections have been implemented as desired.

#### joinFulcrum:

`joinFulcrum` joins the Fulcrum dataframes. The function works to first join the processed field sampling dataframe to the processed isolation dataframe via unique collection labels (`c_label`). Following this join, it selects a “best” photo for each unique C-label based on the existence of a matching photo id in the processed field sampling sample photo dataframe, before joining the aggregated data to this dataframe as well. Finally, the complete merge of the dataframes is achieved when the processed isolation S-labeled plates is joined to this large dataframe on the basis of isolation id (`s_label`).<br>

If the user is using **easyfulcrum** on customized Fulcrum applications other than "Nematode field sampling" and "Nematode isolation", it is recommended that `select_vars` is set to `FALSE`, such that `joinFulcrum` does not only return the default variables.

```{r}
join_fulc <- joinFulcrum(data = proc_fulc, select_vars = TRUE)
```

#### checkJoin:

`checkJoin` conducts 10 different checks for flags in the joined Fulcrum data frame regarding extreme temperatures and altitude values, missing, improper, and/or duplicated C-labels, missing, and/or duplicated isolation records corresponding to these C-labels, and finally unusual sample photo numbers. The `return_flags` option is the same as in `checkTemperatures`, and the function automatically prints the rows where the flags exist. If desired, the user can manually edit values or correct mistakes in the underlying data based on these flags and re-run the pipeline again.

```{r}
flag1.2 <- checkJoin(data = join_fulc, return_flags = TRUE)
```

#### annotateFulcrum:

`annnotateFulcrum` adds spatial information to the joined Fulcrum data frame, noting if sample collections were collected on specific islands, trails, and/or locations. Examples islands, trails, and/or locations from Hawaii are automatically loaded with the package, but a user can specify manually made `.csv` files and place them in _data/raw/annotate_, specifying the base directory as `dir` in `annotateFulcrum` will override the example files.<br>

The `hawaii_islands` and `hawaii_locations` dataframes are composed of simple latitude and longitude starts and ends to create a bounding box, and `hawaii_trails` is composed of a character list of geojson polygon points from geojson output of that can be created on a [bounding box online tool](https://boundingbox.klokantech.com/).

If the user is using **easyfulcrum** on customized Fulcrum applications other than "Nematode field sampling" and "Nematode isolation", it is recommended that `select_vars` is set to `FALSE`, such that `annotateFulcrum` does not only return the default variables.

```{r message = F}
anno_fulc <- annotateFulcrum(data = join_fulc, dir = NULL, select_vars = TRUE)
```

### Reading, processing, and joining genotyping google sheet:

This second group of functions operates to clean the results from the collection specific Google Sheet of genotyping results.<br>

Details on how to create genotyping Google Sheets can be found in the [Nematode Collection Protocol](https://docs.google.com/document/d/1aPgPDYobpxzr0BQYgvUsjPWnAGXZmCSQKQ4sDGBXuYM/edit), look for "wild_isolate_genotyping_template". A template is [linked](https://docs.google.com/spreadsheets/d/1pvdpujuJDTYaMwjjDlivjAnO0MrQuDguU2kRLs9eemQ/edit#gid=0)<br>

#### readGenotypes:

`readGenotypes` reads in genotyping data from a Google Sheet with requisite `gsKey`. The `col_types` variable will specify of what column types the data should be.<br>

For more details on reading in genotyping sheets, look into the [googlesheets4](https://googlesheets4.tidyverse.org/articles/articles/read-sheets.html) package (which underlies this function), as well as further information on how to [specify](https://googlesheets4.tidyverse.org/reference/range_read.html#column-specification) the `col_types` if needed.<br>

Running this function depends on a users connection to the appropriate Google Doc below, which is shared as view only.

```{r}
raw_geno <- readGenotypes(gsKey = c("1iSGkGbhoyg-uq_l83UbiNdI_g4xqEkTxf3Ap0J7JGto"))
head(raw_geno)
```

#### checkGenotypes:

`checkGenotypes` both processes the genotyping data (adds flags) and returns info on those flags if desired, regarding isolations missing, improper, and/or duplicated S-labels, and other checks such as if species ID, strain name, proliferation label and ITS2 genotype are missing and expected based on data in the genotyping sheet. Setting the `return_geno` option to `TRUE` and the `return_flags` option to `FALSE` will return the processed genotyping data and print information on the flags. Setting the `return_geno` option to `FALSE` and the `return_flags` option to `TRUE` will return a list of data frames that detail the rows where the flags appear. Both of these cannot be `TRUE` at the same time.

```{r}
proc_geno <- checkGenotypes(geno_data = raw_geno, fulc_data = anno_fulc, 
                                  return_geno = TRUE, return_flags = FALSE)
```

```{r}
flag1.3 <- checkGenotypes(geno_data = raw_geno, fulc_data = anno_fulc, 
                          return_geno = FALSE, return_flags = TRUE)
```

Based on these flags a new Google Document was made, eliminating rows with blank S-labels or S-labels in the genotyping data but not in the Fulcrum data. `raw_geno` and afterwards `proc_geno` is overwritten with this data.

```{r}
raw_geno <- readGenotypes(gsKey = c("1WlnmujvHBc3s5jwCtRPcT3oHkRvpU-RXXIBmJOV8Qb0"))
proc_geno <- checkGenotypes(geno_data = raw_geno, fulc_data = anno_fulc,
                            return_geno = TRUE, return_flags = FALSE)
```

#### joinGenoFulc:

`joinGenoFulc` will join the joined Fulcrum data frame with the genotyping information. This function will also save the processed genotyping information in _data/processed/genotypes_ if `dir` is set to the base folder of the project.

If the user is using **easyfulcrum** on customized Fulcrum applications other than "Nematode field sampling" and "Nematode isolation", it is recommended that `select_vars` is set to `FALSE`, such that `joinGenoFulc` does not only return the default variables.

```{r}
join_genofulc <- joinGenoFulc(geno = proc_geno, fulc = anno_fulc, dir = NULL, select_vars = TRUE)
```

### Reading, resizing, and joining collection images:

The final function processes and resizes images, adding details to a final dataframe.<br>

#### procPhotos:

`procPhotos` copies raw sample photos, renames them with the C-label, makes a new directory _data/processed/fulcrum/photos_ and pastes the renamed files there. The function also makes thumbnails for use with interactive maps and places these in the _data/processed/fulcrum/photos/thumbnails_ direcotry. Setting the `CeNDR` option to `TRUE` will rename photos of samples meeting CeNDR criteria with the name of the nematode strains isolated from the sample and paste them in the _data/processed/fulcrum/photos/CeNDR_ directory.

The function will also accept a public url (`pub_url`) for hosting the sample photos renamed by C-label. A compatible public url should follow the `pub_url/Project/C-label.jpg` format. For example, if the full url for C-0001 is https://storage.googleapis.com/elegansvariation.org/photos/hawaii2017/C-0001.jpg,
(`pub_url`) should be set to `https://storage.googleapis.com/elegansvariation.org/photos/`

```{r message = FALSE}
final_data <- procPhotos(dir = dir, data = join_genofulc,
                         max_dim = 500, overwrite = TRUE,
                         pub_url = "https://storage.googleapis.com/elegansvariation.org/photos/",
                         CeNDR = TRUE)
head(final_data)
```

### Generating summary and output files:

We include two functions for generating sample output from `final_data`. This final dataframe can otherwise be used as needed by the user. As these depend on a users personal subfolder structure, they are commented out. 

#### makeSpSheet:

`makeSpSheet` generates a species specific `.csv` file for the species of interest (`target_sp`) and writes it to the `/reports` subdirectory. This function simplifies the output of the final dataframe, pulling variables of particular interest for a user specified species of interest. This function is written to standardize the output dataframe to meet the specifications for submitting wild nematode collections to the Caenorhabditis Natural Diversity Resource (CaeNDR). For this reason the `makeSpSheet` function is likely only applicable to nematode sampling projects.<br>

`makeSpSheet` also returns a dataframe with flags for these select samples, and prints a description of these flags.

```{r}
flag1.4 <- makeSpSheet(data = final_data, target_sp = "Caenorhabditis briggsae", dir = dir)
```

#### generateReport:

We provide a function, `generateReport`, that interfaces between `final_data` and `sampleReport.Rmd`, a markdown file that will generate an interactive overview of the entire sampling project. `generateReport` saves `sampleReport.Rmd` into the `/scripts` sub-directory, and generates a `.html` file in the `/reports` sub-directory, that includes: a summary collection project metadata (such as who conducted the respective processes and on what dates they were completed), summary tables of collection and isolation data, interactive maps of where the collections in the project were acquired, and box plots showing the distributions of various environmental parameters at all collection sites. These parameters include substrate temperature, ambient temperature, humidity, and elevation.

Please feel free to edit the `sampleReport.Rmd` as you require once it is moved into the `/scripts` sub-directory.

```{r message = F}
generateReport(data = final_data, dir = dir)
```
